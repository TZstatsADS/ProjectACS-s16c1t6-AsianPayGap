---
title: "Presentation Rmd"
author: "Cycle 1-6"
date: "February 1, 2016"
output: html_document
---
# 1. Introduction
In an article written by USA Today in October, 2014, [High Tech Pay Gap](http://www.usatoday.com/story/tech/2014/10/09/high-tech-pay-gap-hispanics-asians-african-americans/16606121/), research suggested that Asians in the high-tech industry had lower salaries than their white counterparts. This was an interesting statement, seeing as we often believe Asians make more than whites, particularly in high-paying industries such as tech. Using the American Community Survey (ACS) data from 2013, we decided to see if the survey data fit the findings from this article, and if there were similar differences in salary within other high-paying industries. We then took a closer comparative look at three particularly interesting industries, high-tech, finance, and medical, to learn more about why the differences occur.
  
### 1.1 Setting up
Libraries we need along the way:
```{r eval=TRUE, warning=FALSE, message=FALSE}
library(data.table)
library(dplyr)
library(plyr)
library(tidyr)
library(ggplot2)
library(RColorBrewer)
library(maps)
library(rCharts)
library(plotly)
library(gridExtra)
```
### 1.2 Reading the data
RAC1P - Recoded detailed race code
PERNP - Total person's earnings
OCCP - Occupation recode for 2012 and later
PWGTP - (Replicate weights)
SCHL - Educational attainment
ST - State Code

Note: We chose to use OCCP (Occupation) instead of INDP (Industry). The census defines industry as the type of activity at a person’s place of work, and occupation as the kind of work a person does to earn a living. Therefore to get a more accurate sample of those in "high-tech", we will be taking those who fall under "Computer and Mathematical Occupations" (CMM), since high-tech companies can stretch across many industries.
```{r eval=TRUE}
cols <- c('RAC1P', 'PERNP', 'OCCP', 'PWGTP', 'SCHL', 'ST')
pusa <- fread('ss13pusa.csv', select = cols)
pusb <- fread('ss13pusb.csv', select = cols)
pus <- bind_rows(pusa, pusb)
rm(pusa, pusb)
str(pus)
```
### 1.3 Data Manipulation
```{r}
# Remove rows with NA in pus
pus <- pus[complete.cases(pus),]

# Add state names and abbreviations
ST.anno = read.csv('statenames.csv', header = T)
pus <- mutate(pus, STname = ST.anno[ST, 2], STabbr = ST.anno[ST, 3])

# Extract the Asians and Whites data
pus <- filter(pus, RAC1P == 1 | RAC1P == 6)
pus$RAC1P <- as.factor(pus$RAC1P)
levels(pus$RAC1P) <- c('White', 'Asian')

# Recode OCCP and choose eight OCCP with highest salary or significance differences
pus$OCCP <- ifelse(pus$OCCP >= 10 & pus$OCCP <= 430, 1, pus$OCCP)
pus$OCCP <- ifelse(pus$OCCP >= 1005 & pus$OCCP <= 1240, 2, pus$OCCP)
pus$OCCP <- ifelse(pus$OCCP >= 800 & pus$OCCP <= 950, 3, pus$OCCP)
pus$OCCP <- ifelse(pus$OCCP >= 2105 & pus$OCCP <= 2160, 4, pus$OCCP)
pus$OCCP <- ifelse(pus$OCCP >= 3000 & pus$OCCP <= 3540, 5, pus$OCCP)
pus$OCCP <- ifelse(pus$OCCP >= 510 & pus$OCCP <= 740, 6, pus$OCCP)
pus$OCCP <- ifelse(pus$OCCP >= 1300 & pus$OCCP <= 1560, 7, pus$OCCP)
pus$OCCP <- ifelse(pus$OCCP >= 1600 & pus$OCCP <= 1965, 8, pus$OCCP)

pus <- filter(pus, OCCP %in% c(1:8))
pus$OCCP <- as.factor(pus$OCCP)

levels(pus$OCCP) <- c('MGR', 'CMM', 'FIN', 'LGL', 'MED' , 'BUS', 'ENG', 'SCI')
```
# Comparing Asians' and Whites' salaries by different occupations
```{r}
pus_race_occp <- ddply(pus, .(RAC1P, OCCP), summarise, MEAN = weighted.mean(PERNP, PWGTP, na.rm = T))
ggplot(pus_race_occp, aes(x=OCCP  , y=MEAN, fill=factor(RAC1P))) +
    geom_bar(stat="identity",position="dodge") + scale_fill_hue(l=60,c=110) +
    ylab("Mean Salary") + 
    xlab("Industries") + ggtitle(paste("Salary Comparison between Asian & White")) +
    theme(axis.text.x = element_text(angle = 30, hjust = 1),
          panel.background = element_rect(fill = 'white' ))+theme_grey(base_size = 12)
```
# Comparing Asians' and Whites' education levels
```{r}
# Extract BS, MS, Phd data
pus <- filter(pus, SCHL %in% c(21, 22, 24))
pus$SCHL <- as.factor(pus$SCHL)
levels(pus$SCHL) <- c('Bachelor', 'Master', 'Doctorate')
str(pus)


# Specify CMM occupation
CMM <- filter(pus, OCCP == 'CMM')
# Calculate the freq of diff degrees
CMM_Edu <- ddply(CMM, .(RAC1P, SCHL), summarise, Total = length(SCHL))

# Pie Chart of Education in CMM
Asian <- filter(CMM_Edu, RAC1P == 'Asian')
asianDegreePerc <- Asian$Total/sum(Asian$Total)
Asian<- cbind(Asian, asianDegreePerc)
Education <- levels(Asian$SCHL)
White <- filter(CMM_Edu, RAC1P == "White")
whiteDegreePerc <- White$Total/sum(White$Total)
White<- cbind(White, whiteDegreePerc)
asian_plot <- ggplot(Asian, aes(x="", y=asianDegreePerc, fill=Education))+geom_bar(width = 1, stat = "identity")+coord_polar("y", start=0)+scale_fill_brewer(palette="Blues")+theme_minimal()
white_plot <- ggplot(White, aes(x="", y=whiteDegreePerc, fill=Education))+geom_bar(width = 1, stat = "identity")+coord_polar("y", start=0)+scale_fill_brewer(palette="Blues")+theme_minimal()
grid.arrange(asian_plot, white_plot, ncol=2)
```

# For CMM, to every state, Asian or White earn more?
```{r}
CMM_Ansian <- filter(CMM, RAC1P == 'Asian')
CMM_White <- filter(CMM, RAC1P == 'White')
CMM_state_asian <- ddply(CMM_Ansian, .(STname), summarise, Asian = weighted.mean(PERNP, PWGTP))
CMM_state_white <- ddply(CMM_White, .(STname), summarise, White = weighted.mean(PERNP, PWGTP))
CMM_state_asian <- filter(CMM_state_asian, STname != 'NA')
CMM_state_white <- filter(CMM_state_white, STname != 'NA')
state_name <- fread('statenames.csv', select = c('name', 'abbr'))
CMM_state_salary <-merge(state_name, CMM_state_asian, by.x = 'name', by.y = 'STname', all.x = TRUE)
CMM_state_salary <-merge(CMM_state_salary, CMM_state_white, by.x = 'name', by.y = 'STname', all.x = TRUE)

CMM_state_salary$diff <- apply(CMM_state_salary, 1, function(x) {as.numeric(x[3]) - as.numeric(x[4])})
CMM_state_salary[is.na(CMM_state_salary$diff),]$diff <- 0

CMM_state_salary$hover <- with(CMM_state_salary, paste(name, '<br>', "Difference", diff ))
# give state boundaries a white border
l <- list(color = toRGB("white"), width = 2)
# specify some map projection/options
g <- list(
    scope = 'usa',
    projection = list(type = 'albers usa'),
    showlakes = TRUE,
    lakecolor = toRGB('white')
)

plot_ly(CMM_state_salary, z = diff, text = hover, locations = abbr, type = 'choropleth',
        locationmode = 'USA-states', color = diff, colors = 'Blues',
        marker = list(line = l), colorbar = list(title = "USD")) %>%
    layout(title = 'The difference salary between Asians and Whites in every State － CMM', geo = g)
```
# Finance
```{r}
# Specify FIN occupation
FIN <- filter(pus, OCCP == 'FIN')
FIN_Edu <- ddply(FIN, .(RAC1P, SCHL), summarise, Total = length(SCHL))

# Pie Chart of Education in FIN
Asian <- filter(FIN_Edu, RAC1P == 'Asian')
asianDegreePerc <- Asian$Total/sum(Asian$Total)
Asian<- cbind(Asian, asianDegreePerc)
Education <- levels(Asian$SCHL)
White <- filter(FIN_Edu, RAC1P == "White")
whiteDegreePerc <- White$Total/sum(White$Total)
White<- cbind(White, whiteDegreePerc)
asian_plot <- ggplot(Asian, aes(x="", y=asianDegreePerc, fill=Education))+geom_bar(width = 1, stat = "identity")+coord_polar("y", start=0)+scale_fill_brewer(palette="Blues")+theme_minimal()
white_plot <- ggplot(White, aes(x="", y=whiteDegreePerc, fill=Education))+geom_bar(width = 1, stat = "identity")+coord_polar("y", start=0)+scale_fill_brewer(palette="Blues")+theme_minimal()
grid.arrange(asian_plot, white_plot, ncol=2)


# For FIN, to every state, Asian or White earn more?
FIN_Ansian <- filter(FIN, RAC1P == 'Asian')
FIN_White <- filter(FIN, RAC1P == 'White')
FIN_state_asian <- ddply(FIN_Ansian, .(STname), summarise, Asian = weighted.mean(PERNP, PWGTP))
FIN_state_white <- ddply(FIN_White, .(STname), summarise, White = weighted.mean(PERNP, PWGTP))

FIN_state_asian <- filter(FIN_state_asian, STname != 'NA')
FIN_state_white <- filter(FIN_state_white, STname != 'NA')
FIN_state_salary <-merge(state_name, FIN_state_asian, by.x = 'name', by.y = 'STname', all.x = TRUE)
FIN_state_salary <-merge(FIN_state_salary, CMM_state_white, by.x = 'name', by.y = 'STname', all.x = TRUE)

FIN_state_salary$diff <- apply(FIN_state_salary, 1, function(x) {as.numeric(x[3]) - as.numeric(x[4])})
FIN_state_salary[is.na(FIN_state_salary$diff),]$diff <- 0

FIN_state_salary$hover <- with(FIN_state_salary, paste(name, '<br>', "Difference", diff ))
# give state boundaries a white border
l <- list(color = toRGB("white"), width = 2)
# specify some map projection/options
g <- list(
    scope = 'usa',
    projection = list(type = 'albers usa'),
    showlakes = TRUE,
    lakecolor = toRGB('white')
)

plot_ly(FIN_state_salary, z = diff, text = hover, locations = abbr, type = 'choropleth',
        locationmode = 'USA-states', color = diff, colors = 'Reds',
        marker = list(line = l), colorbar = list(title = "USD")) %>%
    layout(title = 'The difference salary between Asians and Whites in every State － FIN', geo = g)
```
# Medicine
```{r}
# For MED, to every state, Asian or White earn more?
MED <- filter(pus, OCCP == 'MED')
MED_Edu <- ddply(MED, .(RAC1P, SCHL), summarise, Total = length(SCHL))

# Pie Chart of Education in MED
Asian <- filter(MED_Edu, RAC1P == 'Asian')
asianDegreePerc <- Asian$Total/sum(Asian$Total)
Asian<- cbind(Asian, asianDegreePerc)
Education <- levels(Asian$SCHL)
White <- filter(MED_Edu, RAC1P == "White")
whiteDegreePerc <- White$Total/sum(White$Total)
White<- cbind(White, whiteDegreePerc)
asian_plot <- ggplot(Asian, aes(x="", y=asianDegreePerc, fill=Education))+geom_bar(width = 1, stat = "identity")+coord_polar("y", start=0)+scale_fill_brewer(palette="Blues")+theme_minimal()
white_plot <- ggplot(White, aes(x="", y=whiteDegreePerc, fill=Education))+geom_bar(width = 1, stat = "identity")+coord_polar("y", start=0)+scale_fill_brewer(palette="Blues")+theme_minimal()
grid.arrange(asian_plot, white_plot, ncol=2)


# For MED, to every state, Asian or White earn more?
MED_Ansian <- filter(MED, RAC1P == 'Asian')
MED_White <- filter(MED, RAC1P == 'White')
MED_state_asian <- ddply(MED_Ansian, .(STname), summarise, Asian = weighted.mean(PERNP, PWGTP))
MED_state_white <- ddply(MED_White, .(STname), summarise, White = weighted.mean(PERNP, PWGTP))


MED_state_asian <- filter(MED_state_asian, STname != 'NA')
MED_state_white <- filter(MED_state_white, STname != 'NA')
MED_state_salary <-merge(state_name, MED_state_asian, by.x = 'name', by.y = 'STname', all.x = TRUE)
MED_state_salary <-merge(MED_state_salary, MED_state_white, by.x = 'name', by.y = 'STname', all.x = TRUE)

MED_state_salary$diff <- apply(MED_state_salary, 1, function(x) {as.numeric(x[3]) - as.numeric(x[4])})
MED_state_salary[is.na(MED_state_salary$diff),]$diff <- 0

MED_state_salary$hover <- with(MED_state_salary, paste(name, '<br>', "Difference", diff ))
# give state boundaries a white border
l <- list(color = toRGB("white"), width = 2)
# specify some map projection/options
g <- list(
    scope = 'usa',
    projection = list(type = 'albers usa'),
    showlakes = TRUE,
    lakecolor = toRGB('white')
)

plot_ly(MED_state_salary, z = diff, text = hover, locations = abbr, type = 'choropleth',
        locationmode = 'USA-states', color = diff, colors = 'Purples',
        marker = list(line = l), colorbar = list(title = "USD")) %>%
    layout(title = 'The difference salary between Asians and Whites in every State － MED', geo = g)
```

